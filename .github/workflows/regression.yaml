name: regression

on:
  push:
    paths:
      - 'base/**'
      - 'overlays/**'
      - 'scripts/**'
      - 'spec/**'
      - '.github/workflows/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  regression:
    permissions: { contents: read }
    timeout-minutes: 30
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: install aqua
        run: |
          curl -sSfL -O https://raw.githubusercontent.com/aquaproj/aqua-installer/v2.1.1/aqua-installer
          echo "c2af02bdd15da6794f9c98db40332c804224930212f553a805425441f8331665  aqua-installer" | sha256sum -c
          chmod +x aqua-installer
          ./aqua-installer
          export PATH="${AQUA_ROOT_DIR:-${XDG_DATA_HOME:-$HOME/.local/share}/aquaproj-aqua}/bin:$PATH"
          export AQUA_GLOBAL_CONFIG=./spec/aqua.yaml
          aqua i -l
      - name: install ruby
        run: |
          sudo apt install ruby rake -y
      - name: install cluster and apps 
        env:
          ENV: ${{ github.ref_name }}
        run: |
          export PATH="${AQUA_ROOT_DIR:-${XDG_DATA_HOME:-$HOME/.local/share}/aquaproj-aqua}/bin:$PATH"
          rake
      - name: post install test
        run: |
          sleep 300
          sudo apt install jq mysql-client -y
          sudo gem install rspec -N
          #rspec -e fluent spec/post_deploy.spec
          rspec spec/post_deploy.spec
